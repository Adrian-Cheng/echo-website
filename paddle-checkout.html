<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECHO Payment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 20px;
        }
        .container {
            text-align: center;
            max-width: 400px;
        }
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #D4AF37, #B8960C);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 32px;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .subtitle {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            margin-bottom: 30px;
        }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: rgba(255,255,255,0.8);
        }
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: #D4AF37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error {
            background: rgba(255,0,0,0.2);
            border: 1px solid rgba(255,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        .success {
            background: rgba(0,255,0,0.2);
            border: 1px solid rgba(0,255,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">◇</div>
        <h1>ECHO PRO</h1>
        <p class="subtitle">Secure Payment Processing</p>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <span id="loadingText">Loading payment...</span>
        </div>
        <div class="error" id="error"></div>
        <div class="success" id="success">
            Payment successful! You can close this page.
        </div>
    </div>

    <!-- Paddle.js -->
    <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
    <script>
        // 获取 URL 参数
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                transactionId: params.get('txn'),
                environment: params.get('env') || 'sandbox',
                clientToken: params.get('token')
            };
        }

        // 初始化 Paddle
        async function initPaddle() {
            const { transactionId, environment, clientToken } = getUrlParams();
            
            if (!transactionId) {
                showError('Missing transaction ID');
                return;
            }

            try {
                // 初始化 Paddle
                if (environment === 'sandbox') {
                    Paddle.Environment.set('sandbox');
                }
                
                Paddle.Initialize({
                    token: clientToken || 'test_51899804c0b7ff1e55014f58640', // Sandbox token
                    eventCallback: function(event) {
                        console.log('Paddle event:', event);
                        
                        if (event.name === 'checkout.completed') {
                            showSuccess();
                            // 通知 App 支付成功
                            if (window.FlutterChannel) {
                                window.FlutterChannel.postMessage(JSON.stringify({
                                    type: 'payment_success',
                                    transactionId: transactionId
                                }));
                            }
                        } else if (event.name === 'checkout.closed') {
                            // 用户关闭了支付弹窗
                            if (window.FlutterChannel) {
                                window.FlutterChannel.postMessage(JSON.stringify({
                                    type: 'payment_cancelled'
                                }));
                            }
                        }
                    }
                });

                // 打开 Checkout
                updateLoadingText('Opening payment...');
                
                Paddle.Checkout.open({
                    transactionId: transactionId,
                    settings: {
                        displayMode: 'overlay',
                        theme: 'dark',
                        locale: navigator.language
                    }
                });

            } catch (error) {
                console.error('Paddle error:', error);
                showError('Failed to load payment: ' + error.message);
            }
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function showSuccess() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('success').style.display = 'block';
        }

        // 页面加载后初始化
        window.onload = initPaddle;
    </script>
</body>
</html>
